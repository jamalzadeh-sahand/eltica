<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mock SSO Server - eltica.org</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .login-form {
            max-width: 400px;
            margin: 0 auto;
        }
        input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            width: 100%;
            padding: 12px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #45a049;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .test-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #eee;
        }
        .test-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .test-buttons button {
            flex: 1;
            background: #2196F3;
        }
        .test-buttons button:hover {
            background: #0b7dda;
        }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Mock SSO Test Server - eltica.org</h1>
        
        <div class="login-form">
            <h2>Login Simulation</h2>
            <input type="text" id="username" placeholder="Username (any value for testing)">
            <input type="password" id="password" placeholder="Password (any value for testing)">
            <button onclick="performLogin()">Login</button>
            <button onclick="performLogout()" style="background: #f44336; margin-top: 10px;">Logout</button>
            
            <div id="loginStatus"></div>
        </div>

        <div class="test-section">
            <h2>Test SSO Redirect Flow</h2>
            <p>Current Session Status: <span id="sessionStatus">Not logged in</span></p>
            
            <div class="test-buttons">
                <button onclick="testMoodleRedirect()">Test Moodle SSO</button>
                <button onclick="testSupportRedirect()">Test Support SSO</button>
            </div>
            
            <div id="redirectInfo" style="margin-top: 20px;"></div>
        </div>

        <div class="test-section">
            <h2>Mock Token/Session Info</h2>
            <pre id="tokenInfo">No active session</pre>
        </div>

        <div class="test-section">
            <h2>Test SAML Response (for Freshdesk)</h2>
            <button onclick="generateSAMLResponse()" style="background: #9C27B0;">Generate Mock SAML Response</button>
            <pre id="samlResponse" style="margin-top: 10px;">Click to generate mock SAML response</pre>
        </div>
    </div>

    <script>
        // Check session on load
        window.onload = function() {
            checkSession();
        };

        function checkSession() {
            const session = localStorage.getItem('mockSession');
            const sessionStatus = document.getElementById('sessionStatus');
            const tokenInfo = document.getElementById('tokenInfo');
            
            if (session) {
                const sessionData = JSON.parse(session);
                sessionStatus.innerHTML = `<span style="color: green;">✓ Logged in as: ${sessionData.username}</span>`;
                tokenInfo.textContent = JSON.stringify(sessionData, null, 2);
            } else {
                sessionStatus.innerHTML = '<span style="color: red;">✗ Not logged in</span>';
                tokenInfo.textContent = 'No active session';
            }
        }

        function performLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const statusDiv = document.getElementById('loginStatus');
            
            if (!username || !password) {
                statusDiv.innerHTML = '<div class="status error">Please enter username and password</div>';
                return;
            }
            
            // Mock authentication - always succeeds for testing
            const mockSession = {
                username: username,
                token: 'mock_jwt_token_' + Math.random().toString(36).substr(2, 9),
                sessionId: 'session_' + Date.now(),
                loginTime: new Date().toISOString(),
                expiresIn: 3600,
                roles: ['user', 'student'],
                email: username + '@eltica.org'
            };
            
            localStorage.setItem('mockSession', JSON.stringify(mockSession));
            statusDiv.innerHTML = '<div class="status success">Login successful! Mock session created.</div>';
            checkSession();
            
            // Check for redirect parameter
            const urlParams = new URLSearchParams(window.location.search);
            const returnUrl = urlParams.get('return_url');
            if (returnUrl) {
                statusDiv.innerHTML += `<div class="status info">Would redirect to: ${returnUrl}</div>`;
            }
        }

        function performLogout() {
            localStorage.removeItem('mockSession');
            document.getElementById('loginStatus').innerHTML = '<div class="status info">Logged out successfully</div>';
            checkSession();
        }

        function testMoodleRedirect() {
            const session = localStorage.getItem('mockSession');
            const infoDiv = document.getElementById('redirectInfo');
            
            if (!session) {
                infoDiv.innerHTML = `
                    <div class="status error">
                        Not authenticated. Would redirect to:<br>
                        <code>eltica.org/auth/login?return_url=moodle.eltica.org</code>
                    </div>
                `;
            } else {
                const sessionData = JSON.parse(session);
                infoDiv.innerHTML = `
                    <div class="status success">
                        Authenticated! Would redirect to Moodle with token:<br>
                        <code>moodle.eltica.org/auth/sso/callback?token=${sessionData.token}</code>
                    </div>
                    <div class="status info" style="margin-top: 10px;">
                        Moodle would receive this user data:
                        <pre>${JSON.stringify({
                            username: sessionData.username,
                            email: sessionData.email,
                            roles: sessionData.roles
                        }, null, 2)}</pre>
                    </div>
                `;
            }
        }

        function testSupportRedirect() {
            const session = localStorage.getItem('mockSession');
            const infoDiv = document.getElementById('redirectInfo');
            
            if (!session) {
                infoDiv.innerHTML = `
                    <div class="status error">
                        Not authenticated. Would redirect to:<br>
                        <code>eltica.org/auth/login?return_url=support.eltica.org</code>
                    </div>
                `;
            } else {
                const sessionData = JSON.parse(session);
                infoDiv.innerHTML = `
                    <div class="status success">
                        Authenticated! Would initiate Freshdesk SSO:<br>
                        <code>support.eltica.org/login/sso?token=${sessionData.token}</code>
                    </div>
                    <div class="status info" style="margin-top: 10px;">
                        Freshdesk would receive SAML assertion with user data
                    </div>
                `;
            }
        }

        function generateSAMLResponse() {
            const session = localStorage.getItem('mockSession');
            const samlDiv = document.getElementById('samlResponse');
            
            if (!session) {
                samlDiv.textContent = 'Error: No active session. Please login first.';
                return;
            }
            
            const sessionData = JSON.parse(session);
            
            // Mock SAML Response structure
            const mockSAML = {
                SAMLResponse: {
                    Assertion: {
                        Subject: {
                            NameID: sessionData.email
                        },
                        AttributeStatement: {
                            Attributes: [
                                { Name: 'email', Value: sessionData.email },
                                { Name: 'name', Value: sessionData.username },
                                { Name: 'given_name', Value: sessionData.username },
                                { Name: 'unique_id', Value: sessionData.sessionId }
                            ]
                        },
                        Conditions: {
                            NotBefore: new Date().toISOString(),
                            NotOnOrAfter: new Date(Date.now() + 3600000).toISOString()
                        }
                    },
                    Signature: 'mock_signature_base64_encoded'
                }
            };
            
            samlDiv.textContent = JSON.stringify(mockSAML, null, 2);
        }
    </script>
</body>
</html>